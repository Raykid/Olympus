import { core } from "../core/Core";
import { Injectable } from "../core/injector/Injector";
import { assetsManager } from "./assets/AssetsManager";
import { bridgeManager } from "./bridge/BridgeManager";
import BridgeMessage from "./bridge/BridgeMessage";
import IBridge from "./bridge/IBridge";
import { environment } from "./env/Environment";
import { hash, IHashModuleData } from "./env/Hash";
import IMediatorConstructor from "./mediator/IMediatorConstructor";
import EngineMessage from "./message/EngineMessage";
import { moduleManager } from "./module/ModuleManager";
import ModuleMessage from "./module/ModuleMessage";
import IPlugin from "./plugin/IPlugin";
import { version } from "./version/Version";

/**
 * @author Raykid
 * @email initial_r@qq.com
 * @create date 2017-09-06
 * @modify date 2017-09-06
 * 
 * Engine模组是开发框架的引擎部分，包括业务模块系统、应用程序启动和初始化、弹窗和场景管理器等与项目开发相关的逻辑都在这个模组中
 * 这个模组的逻辑都高度集成在子模组中了，因此也只是收集相关子模组
*/

export enum InitStep
{
    /** 框架尚未开始初始化 */
    Uninit,
    /** 框架已准备好初始化 */
    ReadyToInit,
    /** 开始执行初始化 */
    StartInit,
    /** 版本号系统初始化完毕 */
    VersionInited,
    /** 表现层桥初始化完毕 */
    BridgesInited,
    /** 预加载，可能会触发多次，每次传递两个参数：预加载文件名或路径、预加载文件内容 */
    Preload,
    /** 开始打开首个模块 */
    OpenFirstModule,
    /** 首个模块打开完毕，初始化流程完毕 */
    Inited
}

@Injectable
export default class Engine
{
    private _initParams:IInitParams;

    /**
     * 获取初始化参数
     *
     * @readonly
     * @type {IInitParams}
     * @memberof Engine
     */
    public get initParams():IInitParams
    {
        return this._initParams;
    }

    private _loadElement:Element;
    
    private _initStep:InitStep = InitStep.Uninit;
    /**
     * 获取框架初始化进程
     *
     * @readonly
     * @type {InitStep}
     * @memberof Engine
     */
    public get initStep():InitStep
    {
        return this._initStep;
    }

    /**
     * 初始化Engine
     * 
     * @param {IInitParams} params 初始化参数
     * @memberof Engine
     */
    public initialize(params:IInitParams):void
    {
        var self:Engine = this;
        // 调用进度回调，初始化为0%
        this._initStep = InitStep.ReadyToInit;
        params.onInitProgress && params.onInitProgress(0, this._initStep);
        // 执行初始化
        if(document.readyState == "loading") document.addEventListener("readystatechange", doInitialize);
        else doInitialize();

        function doInitialize():void
        {
            // 调用进度回调，开始初始化为10%
            self._initStep = InitStep.StartInit;
            params.onInitProgress && params.onInitProgress(0.1, self._initStep);
            // 移除事件
            if(this == document) document.removeEventListener("readystatechange", doInitialize);
            // 要判断document是否初始化完毕
            self._initParams = params;
            // 加载页
            self._loadElement = (typeof params.loadElement == "string" ? document.querySelector(params.loadElement) : params.loadElement);
            // 监听错误事件
            if(params.onError) self.listenError(params.onError);
            // 初始化环境参数
            environment.initialize(params.env, params.hostsDict, params.cdnsDict);
            // 初始化版本号工具
            if(params.hasVersion !== false)
                version.initialize(afterInitVersion, params.version);
            else
                afterInitVersion();
            
            function afterInitVersion():void
            {
                // 调用进度回调，版本号初始化完毕为20%
                self._initStep = InitStep.VersionInited;
                params.onInitProgress && params.onInitProgress(0.2, self._initStep);
                // 监听Bridge初始化完毕事件，显示第一个模块
                core.listen(BridgeMessage.BRIDGE_ALL_INIT, self.onAllBridgesInit, self);
                // 注册并初始化表现层桥实例
                bridgeManager.registerBridge(...params.bridges);
            }
        }
    }

    /**
     * 添加错误监听函数
     * 
     * @param {(evt?:ErrorEvent)=>void} handler 错误监听函数
     * @memberof Engine
     */
    public listenError(handler:(evt?:ErrorEvent)=>void):void
    {
        if(handler) window.addEventListener("error", handler);
    }

    private onAllBridgesInit():void
    {
        // 调用进度回调，表现层桥初始化完毕为30%
        this._initStep = InitStep.BridgesInited;
        this._initParams.onInitProgress && this._initParams.onInitProgress(0.3, this._initStep);
        // 注销监听
        core.unlisten(BridgeMessage.BRIDGE_ALL_INIT, this.onAllBridgesInit, this);
        // 初始化插件
        if(this._initParams.plugins)
        {
            for(var plugin of this._initParams.plugins)
            {
                plugin.initPlugin();
            }
        }
        // 注册短名称
        assetsManager.configPath(this._initParams.pathDict);
        // 开始预加载过程
        var preloads:string[] = this._initParams.preloads;
        if(preloads)
        {
            // 去加载
            var curIndex:number = 0;
            var totalCount:number = preloads.length;
            assetsManager.loadAssets(preloads, this.onPreloadOK.bind(this), null, (key:string, value:any)=>{
                curIndex ++;
                // 调用进度回调，每个预加载文件平分30%-90%的进度
                var progress:number = 0.3 + 0.6 * curIndex / totalCount;
                // 保留2位小数
                progress = Math.round(progress * 100) * 0.01;
                this._initStep = InitStep.Preload;
                this._initParams.onInitProgress && this._initParams.onInitProgress(progress, this._initStep, key, value);
            });
        }
        else
        {
            // 没有预加载，直接完成
            this.onPreloadOK();
        }
    }

    private onPreloadOK():void
    {
        // 调用进度回调，打开首个模块为90%
        this._initStep = InitStep.OpenFirstModule;
        this._initParams.onInitProgress && this._initParams.onInitProgress(0.9, this._initStep);
        // 派发事件
        core.dispatch(EngineMessage.INITIALIZED);
        // 调用初始化完成回调
        this._initParams.onInited && this._initParams.onInited();
        // 监听首个模块开启
        core.listen(ModuleMessage.MODULE_CHANGE, this.onModuleChange, this);
        // 打开首个模块
        moduleManager.open(this._initParams.firstModule, hash.firstModuleParams);
        // 如果有哈希模块则打开之
        for(var i in hash.moduleDatas)
        {
            var data:IHashModuleData = hash.moduleDatas[i];
            // 如果模块没有名字则不进行操作
            if(data.name)
                moduleManager.open(data.name, data.params, data.direct);
        }
    }

    private onModuleChange(from:IMediatorConstructor):void
    {
        // 调用进度回调，全部过程完毕，100%
        this._initStep = InitStep.Inited;
        this._initParams.onInitProgress && this._initParams.onInitProgress(1, this._initStep);
        // 注销监听
        core.unlisten(ModuleMessage.MODULE_CHANGE, this.onModuleChange, this);
        // 移除loadElement显示
        if(this._loadElement)
        {
            var parent:Element = this._loadElement.parentElement;
            parent && parent.removeChild(this._loadElement);
        }
    }
}
/** 再额外导出一个单例 */
export const engine:Engine = core.getInject(Engine);

export interface IInitParams
{
    /**
     * 表现层桥数组，所有可能用到的表现层桥都要在此实例化并传入
     * 
     * @type {IBridge[]}
     * @memberof OlympusInitParams
     */
    bridges:IBridge[];
    /**
     * 首模块类型，框架初始化完毕后进入的模块
     * 
     * @type {IMediatorConstructor}
     * @memberof OlympusInitParams
     */
    firstModule:IMediatorConstructor;
    /**
     * 会在首个模块被显示出来后从页面中移除
     * 
     * @type {(Element|string)}
     * @memberof OlympusInitParams
     */
    loadElement?:Element|string;
    /**
     * 环境字符串，默认为"dev"
     * 
     * @type {string}
     * @memberof IInitParams
     */
    env?:string;
    /**
     * 是否要使用版本机制，默认为true
     *
     * @type {boolean}
     * @memberof IInitParams
     */
    hasVersion?:boolean;
    /**
     * 加载version.cfg文件的版本号，不传则使用随机时间戳作为版本号
     * 
     * @type {string}
     * @memberof IInitParams
     */
    version?:string;
    /**
     * 消息域名字典数组，首个字典会被当做默认字典，没传递则会用当前域名代替
     * 
     * @type {{[env:string]:string[]}}
     * @memberof IInitParams
     */
    hostsDict?:{[env:string]:string[]};
    /**
     * CDN域名列表，若没有提供则使用host代替
     * 
     * @type {{[env:string]:string[]}}
     * @memberof IInitParams
     */
    cdnsDict?:{[env:string]:string[]};
    /**
     * 插件列表
     * 
     * @type {IPlugin[]}
     * @memberof IInitParams
     */
    plugins?:IPlugin[];
    /**
     * 短名称路径字典，key是短名称，value是路径
     * 
     * @type {{[key:string]:string}}
     * @memberof IInitParams
     */
    pathDict?:{[key:string]:string},
    /**
     * 预加载数组或字典，如果是字典则key为短名称，value为资源路径
     * 会在表现层桥初始化完毕后、框架初始化完毕前加载，加载结果会保存在AssetsManager中
     * 
     * @type {string[]}
     * @memberof IInitParams
     */
    preloads?:string[];
    /**
     * 初始化进度变化时调用，第一个参数为进度数值，范围是[0, 1]；第二个参数是所在步骤枚举值；第三个参数是步骤提供的参数列表
     * 
     * @memberof IInitParams
     */
    onInitProgress?:(progress?:number, step?:InitStep, ...args:any[])=>void;
    /**
     * 框架初始化完毕时调用
     * 
     * @type {()=>void}
     * @memberof IInitParams
     */
    onInited?:()=>void;
    /**
     * 项目出现报错时调用，提供Error对象和ErrorEvent对象
     * 
     * @memberof IInitParams
     */
    onError?:(evt?:ErrorEvent)=>void;
}